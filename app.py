import streamlit as st
import pandas as pd
import xml.etree.ElementTree as ET

# --- 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ---
st.set_page_config(page_title="ุชุญุตูู ุดุงู ุงูุญุฏูุซุฉ", layout="wide")

st.title("๐ธ ูุฏููููุฉ ุงูุนููุงุก - ุงููุงุฆูุฉ ุงููุญุฏุฏุฉ")
st.markdown("### ุงููุณุชูุฏู ุงูููุงุฆู: **218,789.96** ุฑ.ุณ")

# --- 2. ุฏุงูุฉ ุงููุฑุงุกุฉ ุงููุจุงุดุฑุฉ ---
def load_data(file):
    if file is None: return None
    file.seek(0)
    try:
        tree = ET.parse(file)
        root = tree.getroot()
        data = []
        for row in root:
            data.append({child.tag: child.text for child in row})
        return pd.DataFrame(data)
    except Exception as e:
        st.error(f"ูุดู ุงููุฑุงุกุฉ: {e}")
        return None

# --- 3. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ---
with st.sidebar:
    st.header("๐ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช")
    f_ledger = st.file_uploader("ุงุฑูุน ููู LedgerBook.xml", type=['xml'], key="ledger_named_final")

# --- 4. ุงููุนุงูุฌุฉ ุจูุงุกู ุนูู ูุงุฆูุชู ุงูุฌุฏูุฏุฉ ---
if f_ledger:
    df_raw = load_data(f_ledger)
    if df_raw is not None:
        try:
            # ุชุญููู ุงููุจุงูุบ
            df_raw['Dr'] = pd.to_numeric(df_raw['Dr'], errors='coerce').fillna(0)
            df_raw['Cr'] = pd.to_numeric(df_raw['Cr'], errors='coerce').fillna(0)
            
            # --- ุงููุงุฆูุฉ ุงููุญุฏุซุฉ (ุงูุชู ุฃุฑุณูุชูุง ุงูุขู) ---
            target_names = [
                "ุดุฑูุฉ ุงูุฑูุงุฏุฉ ุงูุนุฑุจูุฉ ุงูุชุฌุงุฑูุฉ", "ุดุฑูุฉ ุฃุตู ุงูุดุฑู ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช ูุฑุน 14", "ุดุฑูุฉ ุฑูู ุงูุฃูุฌุงุฏ ุงููุชุญุฏุฉ ููุชุฌุงุฑุฉ",
                "ุดุฑูุฉ ููุฌูุฏ ุงููุชุญุฏุฉ ููุชุฌุงุฑุฉ", "ูุคุณุณุฉ ูุชูู ุงูุบุฑุจูุฉ ุงูุชุฌุงุฑูุฉ", "ุดุฑูุฉ ุจู ุดูููู ุงูุจุฑูุฉ ุงูุชุฌุงุฑูุฉ ูุฑุน 14",
                "ูุคุณุณุฉ ุนูู ูุฑูุฏ ุนูู ุงููุฑููู (ุนุงูู ุงู ุฌู)", "ุดุฑูุฉ ุฎุงูุฏ ุญุงูุฏ ุณุงูู ุงููุญูุงุฏู ุงูุชุฌุงุฑูุฉ", "ูุคุณุณุฉ ุฌูุฏ ุงูุฌุฒูุฑุฉ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช",
                "ูุคุณุณุฉ ุงูุงุจุฏุงุน ุงูุตููู ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช", "ูุคุณุณุฉ ุนูุงุทู ุณุงูู ุจุงุฌุงุจุฑ", "ุดุฑูุฉ ุงุฑุถ ุงูุฐูุจ ููุฐูุจ ู ุงููุฌููุฑุงุช",
                "ุดุฑูุฉ ุจู ุดูููู ุงูุจุฑูุฉ ุงูุชุฌุงุฑูุฉ ูุฑุน ุงููุฒูุฉ", "ูุคุณุณุฉ ุงูุฑุงูู ุงูุนุงููู ููุทุน ุงูุบูุงุฑ", "ูุคุณุณุฉ ุงูุงูุจุงู ุงูุชุฌุงุฑูุฉ",
                "ูุคุณุณุฉ ุงูุงูุฏุงุฏ ุงูุญุตุฑู ุงูุชุฌุงุฑูุฉ", "ูุคุณุณุฉ ุฑูุงุฏ ุงูุฌูุฏุฉ ููุทุน ุงูุบูุงุฑ", "ูุคุณุณุฉ ููุงู ุงููุฑุณุงู ููุชุฌุงุฑุฉ",
                "ูุคุณุณุฉ ุงูููุงุก ุงูุฎุงูุฏุฉ ูุชุฌุงุฑุฉ ุงูุฌููุฉ ูุงูุชุฌุฒุฆุฉ", "ุดุฑูุฉ ุฃุตู ุงููุตุฏุฑ ุงูุฑุงุฆุฏุฉ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช",
                "ูุคุณุณุฉ ุนุจูุฏ ุตุงูุญ ุจุงุญุดูุงู ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช", "ุดุฑูุฉ ุงุณุทูุฑุฉ ุงูุดุฑู ุงูุชุฌุงุฑูุฉ", "ูุคุณุณุฉ ุงูุดุงูู ุงููุชููุฒ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช",
                "ุดุฑูุฉ ุฃุตู ุงูุดุฑู ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช ูุฑุน ุจูู ูุงูู", "ุดุฑูุฉ ุฑูู ุงูุตูุงุนูุฉ ููุชุฌุงุฑุฉ", "ูุคุณุณุฉ ุฑูุงุฏ ุงุณูุง ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช",
                "ุดุฑูุฉ ููุจ ุงูุตูุฑ ููุชุฌุงุฑุฉ", "ุดุฑูุฉ ุงูุงุชุญุงุฏ ุงููุชุทูุฑุฉ ููุชุฌุงุฑุฉ", "ูุคุณุณุฉ ุฑูุฒ ุงูุตููุฉ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช 3 ูุฑุน ูุญุงูู",
                "ุดุฑูุฉ ุชูููู ุงูุฎููุฌูุฉ ููุชุฌุงุฑุฉ", "ูุคุณุณุฉ ุญููู ุงููุฑูุจุฉ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช", "ูุคุณุณุฉ ุฑูุฒ ุงูุตููุฉ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช ุงููุฑูุฒ ุงูุตููู ุจูู ูุงูู",
                "ุดุฑูุฉ ุงูุณูุงู ุงูุชุฌุงุฑูุฉ", "ุดุฑูุฉ ุงููุญุฑู ุงูุฃูุถู ูุชุฌุงุฑุฉ ุงูุฌููุฉ ูุงูุชุฌุฒุฆุฉ", "ูุคุณุณุฉ ุงูุฒุนูู ูุงุญุฏ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช",
                "ูุคุณุณุฉ ุงููุณุชูุจู ุงูุญุฏูุซ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช", "ุฎุงูู ุณุงูู", "ูุคุณุณุฉ ุฏุฑุจ ุงูุนุทุงุก ุงููุชูุงูู ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช",
                "ุดุฑูุฉ ุงูุฅูุฌุงุฒุงุช ูุชุฌุงุฑุฉ ุงูุฌููุฉ ู ุงูุชุฌุฒุฆุฉ", "ูููุฐุฉ ููุทุน ุบูุงุฑ ุงูุณูุงุฑุงุช"
            ]
            
            # ุงูุชุฌููุน ูุงูุจุญุซ ุจุงูุงุณู
            summary = df_raw.groupby('LedgerName').agg({'Dr': 'sum', 'Cr': 'sum'}).reset_index()
            summary['Balance'] = summary['Dr'] - summary['Cr']
            
            # ููุชุฑุฉ ุงูุฃุณูุงุก ุงููุฐููุฑุฉ ููุท
            # ุงุณุชุฎุฏููุง .str.strip() ูุถูุงู ุนุฏู ุชุฃุซุฑ ุงูุจุญุซ ุจูุณุงูุงุช ุฒุงุฆุฏุฉ ูู ููู ุงูู XML
            final_debtors = summary[summary['LedgerName'].str.strip().isin([n.strip() for n in target_names])]
            final_debtors = final_debtors.sort_values('Balance', ascending=False)

            # --- 5. ุนุฑุถ ุงููุชุงุฆุฌ ---
            total_val = final_debtors['Balance'].sum()
            count_found = len(final_debtors)
            
            c1, c2 = st.columns(2)
            c1.metric("ุฅุฌูุงูู ุงููุฏููููุฉ (ูููุงุฆูุฉ ุงููุญุฏุฏุฉ)", f"{total_val:,.2f} ุฑ.ุณ")
            c2.metric("ุนุฏุฏ ุงูุนููุงุก ุงูููุฌูุฏูู ูู ุงูููู", f"{count_found}")
            
            target = 218789.96
            if abs(total_val - target) < 1:
                st.success(f"โ ุชู ุงูุชุทุงุจู ุงูุชุงู ูุน ุงููุณุชูุฏู: {target:,.2f} ุฑ.ุณ")
            else:
                st.warning(f"ุงููุณุชูุฏู ูู ุชูุฑูุฑ ุงูุจุฑูุงูุฌ: {target:,.2f} ุฑ.ุณ (ุงููุฑู: {target - total_val:,.2f})")
            
            st.divider()
            st.subheader("๐ ูุดู ุฃุฑุตุฏุฉ ุงูุนููุงุก (ุญุณุจ ุงููุงุฆูุฉ)")
            st.dataframe(
                final_debtors[['LedgerName', 'Balance']], 
                column_config={"Balance": st.column_config.NumberColumn("ุงูุฑุตูุฏ ุงููุชุจูู", format="%.2f")},
                use_container_width=True, 
                height=600
            )
            
        except Exception as e:
            st.error(f"ุฎุทุฃ ูู ุงููุนุงูุฌุฉ: {e}")
else:
    st.info("๐ก ุงุฑูุน ููู LedgerBook.xml ูุนุฑุถ ุฃุฑุตุฏุฉ ุงููุงุฆูุฉ ุงููุญุฏุฏุฉ.")
